{"version":3,"sources":["../../src/plugin.ts"],"sourcesContent":["import type { PostProcessOptions, SourceMap } from '@metamask/snaps-utils';\nimport {\n  checkManifest,\n  evalBundle,\n  postProcessBundle,\n  useTemporaryFile,\n} from '@metamask/snaps-utils';\nimport { assert } from '@metamask/utils';\nimport pathUtils from 'path';\nimport { promisify } from 'util';\nimport type { Compiler } from 'webpack';\nimport { Compilation, WebpackError } from 'webpack';\nimport { RawSource, SourceMapSource } from 'webpack-sources';\n\nconst PLUGIN_NAME = 'SnapsWebpackPlugin';\n\ntype PluginOptions = {\n  eval?: boolean;\n  manifestPath?: string;\n  writeManifest?: boolean;\n};\n\nexport type Options = PluginOptions &\n  Omit<PostProcessOptions, 'sourceMap' | 'inputSourceMap'>;\n\nexport default class SnapsWebpackPlugin {\n  public readonly options: Partial<Options>;\n\n  /**\n   * Construct an instance of the plugin.\n   *\n   * @param options - The post-process options.\n   * @param options.stripComments - Whether to strip comments. Defaults to\n   * `true`.\n   * @param options.eval - Whether to evaluate the bundle to test SES\n   * compatibility. Defaults to `true`.\n   * @param options.manifestPath - The path to the manifest file. If provided,\n   * the manifest will be validated. Defaults to\n   * `process.cwd() + '/snap.manifest.json'`.\n   * @param options.writeManifest - Whether to fix the manifest.\n   * Defaults to `true`.\n   */\n  constructor(options?: Partial<Options>) {\n    this.options = {\n      eval: true,\n      manifestPath: pathUtils.join(process.cwd(), 'snap.manifest.json'),\n      writeManifest: true,\n      ...options,\n    };\n  }\n\n  /**\n   * Apply the plugin to the Webpack compiler. Hooks into the `processAssets`\n   * stage to process the bundle.\n   *\n   * @param compiler - The Webpack compiler.\n   */\n  apply(compiler: Compiler) {\n    const { devtool } = compiler.options;\n\n    compiler.hooks.compilation.tap(PLUGIN_NAME, (compilation) => {\n      compilation.hooks.processAssets.tap(\n        {\n          name: PLUGIN_NAME,\n          stage: Compilation.PROCESS_ASSETS_STAGE_OPTIMIZE_COMPATIBILITY,\n          additionalAssets: true,\n        },\n        (assets) => {\n          Object.keys(assets)\n            .filter((assetName) => assetName.endsWith('.js'))\n            .forEach((assetName) => {\n              const asset = assets[assetName];\n              const source = asset.source() as string;\n              const sourceMap = asset.map();\n\n              const processed = postProcessBundle(source, {\n                ...this.options,\n                sourceMap: Boolean(devtool),\n                inputSourceMap: devtool ? (sourceMap as SourceMap) : undefined,\n              });\n\n              if (processed.warnings.length > 0) {\n                compilation.warnings.push(\n                  new WebpackError(\n                    `${PLUGIN_NAME}: Bundle Warning: Processing of the Snap bundle completed with warnings.\\n${processed.warnings.join(\n                      '\\n',\n                    )}`,\n                  ),\n                );\n              }\n\n              const replacement = processed.sourceMap\n                ? new SourceMapSource(\n                    processed.code,\n                    assetName,\n                    processed.sourceMap,\n                    source,\n                    sourceMap as SourceMap,\n                  )\n                : new RawSource(processed.code);\n\n              // For some reason the type of `RawSource` is not compatible with\n              // Webpack's own `Source`, but works fine when casting it to `any`.\n              compilation.updateAsset(assetName, replacement as any);\n            });\n        },\n      );\n    });\n\n    compiler.hooks.afterEmit.tapPromise(PLUGIN_NAME, async (compilation) => {\n      const file = compilation\n        .getAssets()\n        .find((asset) => asset.name.endsWith('.js'));\n\n      assert(file);\n\n      assert(compilation.outputOptions.path);\n      const outputPath = compilation.outputOptions.path;\n\n      const filePath = pathUtils.join(outputPath, file.name);\n\n      const bundleFile = await promisify(\n        compiler.outputFileSystem.readFile.bind(compiler.outputFileSystem),\n      )(filePath);\n      assert(bundleFile);\n\n      const bundleContent = bundleFile.toString();\n\n      if (this.options.eval) {\n        await useTemporaryFile('snaps-bundle.js', bundleContent, (path) =>\n          evalBundle(path),\n        );\n      }\n\n      if (this.options.manifestPath) {\n        const { errors, warnings } = await checkManifest(\n          pathUtils.dirname(this.options.manifestPath),\n          this.options.writeManifest,\n          bundleContent,\n          promisify(\n            compiler.outputFileSystem.writeFile.bind(compiler.outputFileSystem),\n          ),\n        );\n\n        if (!this.options.writeManifest && errors.length > 0) {\n          throw new Error(\n            `Manifest Error: The manifest is invalid.\\n${errors.join('\\n')}`,\n          );\n        }\n\n        if (warnings.length > 0) {\n          compilation.warnings.push(\n            new WebpackError(\n              `${PLUGIN_NAME}: Manifest Warning: Validation of snap.manifest.json completed with warnings.\\n${warnings.join(\n                '\\n',\n              )}`,\n            ),\n          );\n        }\n      }\n    });\n  }\n}\n"],"names":["SnapsWebpackPlugin","PLUGIN_NAME","apply","compiler","devtool","options","hooks","compilation","tap","processAssets","name","stage","Compilation","PROCESS_ASSETS_STAGE_OPTIMIZE_COMPATIBILITY","additionalAssets","assets","Object","keys","filter","assetName","endsWith","forEach","asset","source","sourceMap","map","processed","postProcessBundle","Boolean","inputSourceMap","undefined","warnings","length","push","WebpackError","join","replacement","SourceMapSource","code","RawSource","updateAsset","afterEmit","tapPromise","file","getAssets","find","assert","outputOptions","path","outputPath","filePath","pathUtils","bundleFile","promisify","outputFileSystem","readFile","bind","bundleContent","toString","eval","useTemporaryFile","evalBundle","manifestPath","errors","checkManifest","dirname","writeManifest","writeFile","Error","constructor","process","cwd"],"mappings":"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"}