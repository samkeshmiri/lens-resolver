{"version":3,"sources":["../../../src/common/validation.ts"],"sourcesContent":["import { ChainIdStruct, HandlerType } from '@metamask/snaps-utils';\nimport type { Json, JsonRpcSuccess } from '@metamask/utils';\nimport {\n  assertStruct,\n  JsonRpcIdStruct,\n  JsonRpcRequestStruct,\n  JsonRpcSuccessStruct,\n  JsonStruct,\n} from '@metamask/utils';\nimport type { Infer } from 'superstruct';\nimport {\n  array,\n  assign,\n  enums,\n  is,\n  literal,\n  nullable,\n  object,\n  omit,\n  optional,\n  record,\n  string,\n  tuple,\n  union,\n} from 'superstruct';\n\nconst VALIDATION_FUNCTIONS = {\n  [HandlerType.OnRpcRequest]: validateFunctionExport,\n  [HandlerType.OnTransaction]: validateFunctionExport,\n  [HandlerType.OnCronjob]: validateFunctionExport,\n};\n\n/**\n * Validates a function export.\n *\n * @param snapExport - The export itself.\n * @returns True if the export matches the expected shape, false otherwise.\n */\nfunction validateFunctionExport(\n  snapExport: unknown,\n): snapExport is (...args: unknown[]) => unknown {\n  return typeof snapExport === 'function';\n}\n\n/**\n * Validates a given snap export.\n *\n * @param type - The type of export expected.\n * @param snapExport - The export itself.\n * @returns True if the export matches the expected shape, false otherwise.\n */\nexport function validateExport(type: HandlerType, snapExport: unknown) {\n  const validationFunction = VALIDATION_FUNCTIONS[type];\n  return validationFunction?.(snapExport) ?? false;\n}\n\nexport const JsonRpcRequestWithoutIdStruct = assign(\n  omit(JsonRpcRequestStruct, ['id']),\n  object({\n    id: optional(JsonRpcIdStruct),\n  }),\n);\n\nexport type JsonRpcRequestWithoutId = Infer<\n  typeof JsonRpcRequestWithoutIdStruct\n>;\n\nexport const EndowmentStruct = string();\nexport type Endowment = Infer<typeof EndowmentStruct>;\n\n/**\n * Check if the given value is an endowment.\n *\n * @param value - The value to check.\n * @returns Whether the value is an endowment.\n */\nexport function isEndowment(value: unknown): value is Endowment {\n  return is(value, EndowmentStruct);\n}\n\n/**\n * Check if the given value is an array of endowments.\n *\n * @param value - The value to check.\n * @returns Whether the value is an array of endowments.\n */\nexport function isEndowmentsArray(value: unknown): value is Endowment[] {\n  return Array.isArray(value) && value.every(isEndowment);\n}\n\nconst OkStruct = literal('OK');\n\nexport const PingRequestArgumentsStruct = optional(\n  union([literal(undefined), array()]),\n);\n\nexport const TerminateRequestArgumentsStruct = union([\n  literal(undefined),\n  array(),\n]);\n\nexport const ExecuteSnapRequestArgumentsStruct = tuple([\n  string(),\n  string(),\n  optional(array(EndowmentStruct)),\n]);\n\nexport const SnapRpcRequestArgumentsStruct = tuple([\n  string(),\n  enums(Object.values(HandlerType)),\n  string(),\n  assign(\n    JsonRpcRequestWithoutIdStruct,\n    object({\n      params: optional(record(string(), JsonStruct)),\n    }),\n  ),\n]);\n\nexport type PingRequestArguments = Infer<typeof PingRequestArgumentsStruct>;\nexport type TerminateRequestArguments = Infer<\n  typeof TerminateRequestArgumentsStruct\n>;\n\nexport type ExecuteSnapRequestArguments = Infer<\n  typeof ExecuteSnapRequestArgumentsStruct\n>;\n\nexport type SnapRpcRequestArguments = Infer<\n  typeof SnapRpcRequestArgumentsStruct\n>;\n\nexport type RequestArguments =\n  | PingRequestArguments\n  | TerminateRequestArguments\n  | ExecuteSnapRequestArguments\n  | SnapRpcRequestArguments;\n\nexport const OnTransactionRequestArgumentsStruct = object({\n  // TODO: Improve `transaction` type.\n  transaction: record(string(), JsonStruct),\n  chainId: ChainIdStruct,\n  transactionOrigin: nullable(string()),\n});\n\nexport type OnTransactionRequestArguments = Infer<\n  typeof OnTransactionRequestArgumentsStruct\n>;\n\n/**\n * Asserts that the given value is a valid {@link OnTransactionRequestArguments}\n * object.\n *\n * @param value - The value to validate.\n * @throws If the value is not a valid {@link OnTransactionRequestArguments}\n * object.\n */\nexport function assertIsOnTransactionRequestArguments(\n  value: unknown,\n): asserts value is OnTransactionRequestArguments {\n  assertStruct(\n    value,\n    OnTransactionRequestArgumentsStruct,\n    'Invalid request params',\n  );\n}\n\nconst OkResponseStruct = assign(\n  JsonRpcSuccessStruct,\n  object({\n    result: OkStruct,\n  }),\n);\n\nconst SnapRpcResponse = JsonRpcSuccessStruct;\n\nexport type OkResponse = Infer<typeof OkResponseStruct>;\nexport type SnapRpcResponse = Infer<typeof SnapRpcResponse>;\n\nexport type Response = OkResponse | SnapRpcResponse;\n\ntype RequestParams<Params extends unknown[] | undefined> =\n  Params extends undefined ? [] : Params;\n\ntype RequestFunction<\n  Args extends RequestArguments,\n  ResponseType extends JsonRpcSuccess<Json>,\n> = (...args: RequestParams<Args>) => Promise<ResponseType['result']>;\n\nexport type Ping = RequestFunction<PingRequestArguments, OkResponse>;\nexport type Terminate = RequestFunction<TerminateRequestArguments, OkResponse>;\nexport type ExecuteSnap = RequestFunction<\n  ExecuteSnapRequestArguments,\n  OkResponse\n>;\nexport type SnapRpc = RequestFunction<SnapRpcRequestArguments, SnapRpcResponse>;\n"],"names":["validateExport","JsonRpcRequestWithoutIdStruct","EndowmentStruct","isEndowment","isEndowmentsArray","PingRequestArgumentsStruct","TerminateRequestArgumentsStruct","ExecuteSnapRequestArgumentsStruct","SnapRpcRequestArgumentsStruct","OnTransactionRequestArgumentsStruct","assertIsOnTransactionRequestArguments","VALIDATION_FUNCTIONS","HandlerType","OnRpcRequest","validateFunctionExport","OnTransaction","OnCronjob","snapExport","type","validationFunction","assign","omit","JsonRpcRequestStruct","object","id","optional","JsonRpcIdStruct","string","value","is","Array","isArray","every","OkStruct","literal","union","undefined","array","tuple","enums","Object","values","params","record","JsonStruct","transaction","chainId","ChainIdStruct","transactionOrigin","nullable","assertStruct","OkResponseStruct","JsonRpcSuccessStruct","result","SnapRpcResponse"],"mappings":";;;;;;;;;;;IAmDgBA,cAAc;eAAdA;;IAKHC,6BAA6B;eAA7BA;;IAWAC,eAAe;eAAfA;;IASGC,WAAW;eAAXA;;IAUAC,iBAAiB;eAAjBA;;IAMHC,0BAA0B;eAA1BA;;IAIAC,+BAA+B;eAA/BA;;IAKAC,iCAAiC;eAAjCA;;IAMAC,6BAA6B;eAA7BA;;IA+BAC,mCAAmC;eAAnCA;;IAmBGC,qCAAqC;eAArCA;;;4BA7J2B;uBAQpC;6BAgBA;AAEP,MAAMC,uBAAuB;IAC3B,CAACC,uBAAW,CAACC,YAAY,CAAC,EAAEC;IAC5B,CAACF,uBAAW,CAACG,aAAa,CAAC,EAAED;IAC7B,CAACF,uBAAW,CAACI,SAAS,CAAC,EAAEF;AAC3B;AAEA;;;;;CAKC,GACD,SAASA,uBACPG,UAAmB;IAEnB,OAAO,OAAOA,eAAe;AAC/B;AASO,SAASjB,eAAekB,IAAiB,EAAED,UAAmB;IACnE,MAAME,qBAAqBR,oBAAoB,CAACO,KAAK;IACrD,OAAOC,qBAAqBF,eAAe;AAC7C;AAEO,MAAMhB,gCAAgCmB,IAAAA,mBAAM,EACjDC,IAAAA,iBAAI,EAACC,2BAAoB,EAAE;IAAC;CAAK,GACjCC,IAAAA,mBAAM,EAAC;IACLC,IAAIC,IAAAA,qBAAQ,EAACC,sBAAe;AAC9B;AAOK,MAAMxB,kBAAkByB,IAAAA,mBAAM;AAS9B,SAASxB,YAAYyB,KAAc;IACxC,OAAOC,IAAAA,eAAE,EAACD,OAAO1B;AACnB;AAQO,SAASE,kBAAkBwB,KAAc;IAC9C,OAAOE,MAAMC,OAAO,CAACH,UAAUA,MAAMI,KAAK,CAAC7B;AAC7C;AAEA,MAAM8B,WAAWC,IAAAA,oBAAO,EAAC;AAElB,MAAM7B,6BAA6BoB,IAAAA,qBAAQ,EAChDU,IAAAA,kBAAK,EAAC;IAACD,IAAAA,oBAAO,EAACE;IAAYC,IAAAA,kBAAK;CAAG;AAG9B,MAAM/B,kCAAkC6B,IAAAA,kBAAK,EAAC;IACnDD,IAAAA,oBAAO,EAACE;IACRC,IAAAA,kBAAK;CACN;AAEM,MAAM9B,oCAAoC+B,IAAAA,kBAAK,EAAC;IACrDX,IAAAA,mBAAM;IACNA,IAAAA,mBAAM;IACNF,IAAAA,qBAAQ,EAACY,IAAAA,kBAAK,EAACnC;CAChB;AAEM,MAAMM,gCAAgC8B,IAAAA,kBAAK,EAAC;IACjDX,IAAAA,mBAAM;IACNY,IAAAA,kBAAK,EAACC,OAAOC,MAAM,CAAC7B,uBAAW;IAC/Be,IAAAA,mBAAM;IACNP,IAAAA,mBAAM,EACJnB,+BACAsB,IAAAA,mBAAM,EAAC;QACLmB,QAAQjB,IAAAA,qBAAQ,EAACkB,IAAAA,mBAAM,EAAChB,IAAAA,mBAAM,KAAIiB,iBAAU;IAC9C;CAEH;AAqBM,MAAMnC,sCAAsCc,IAAAA,mBAAM,EAAC;IACxD,oCAAoC;IACpCsB,aAAaF,IAAAA,mBAAM,EAAChB,IAAAA,mBAAM,KAAIiB,iBAAU;IACxCE,SAASC,yBAAa;IACtBC,mBAAmBC,IAAAA,qBAAQ,EAACtB,IAAAA,mBAAM;AACpC;AAcO,SAASjB,sCACdkB,KAAc;IAEdsB,IAAAA,mBAAY,EACVtB,OACAnB,qCACA;AAEJ;AAEA,MAAM0C,mBAAmB/B,IAAAA,mBAAM,EAC7BgC,2BAAoB,EACpB7B,IAAAA,mBAAM,EAAC;IACL8B,QAAQpB;AACV;AAGF,MAAMqB,kBAAkBF,2BAAoB"}