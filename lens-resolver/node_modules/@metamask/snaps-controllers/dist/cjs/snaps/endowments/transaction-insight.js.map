{"version":3,"sources":["../../../../src/snaps/endowments/transaction-insight.ts"],"sourcesContent":["import type {\n  PermissionSpecificationBuilder,\n  EndowmentGetterParams,\n  ValidPermissionSpecification,\n  PermissionValidatorConstraint,\n  PermissionConstraint,\n  CaveatSpecificationConstraint,\n  Caveat,\n} from '@metamask/permission-controller';\nimport { PermissionType, SubjectType } from '@metamask/permission-controller';\nimport { SnapCaveatType } from '@metamask/snaps-utils';\nimport type { Json, NonEmptyArray } from '@metamask/utils';\nimport { assert, hasProperty, isObject, isPlainObject } from '@metamask/utils';\nimport { ethErrors } from 'eth-rpc-errors';\n\nimport { SnapEndowments } from './enum';\n\nconst permissionName = SnapEndowments.TransactionInsight;\n\ntype TransactionInsightEndowmentSpecification = ValidPermissionSpecification<{\n  permissionType: PermissionType.Endowment;\n  targetName: typeof permissionName;\n  endowmentGetter: (_options?: EndowmentGetterParams) => undefined;\n  allowedCaveats: Readonly<NonEmptyArray<string>> | null;\n  validator: PermissionValidatorConstraint;\n}>;\n\n/**\n * `endowment:transaction-insight` returns nothing; it is intended to be used as a flag\n * by the extension to detect whether the snap has the capability to show information on the transaction confirmation screen.\n *\n * @param _builderOptions - Optional specification builder options.\n * @returns The specification for the transaction-insight endowment.\n */\nconst specificationBuilder: PermissionSpecificationBuilder<\n  PermissionType.Endowment,\n  any,\n  TransactionInsightEndowmentSpecification\n> = (_builderOptions?: unknown) => {\n  return {\n    permissionType: PermissionType.Endowment,\n    targetName: permissionName,\n    allowedCaveats: [SnapCaveatType.TransactionOrigin],\n    endowmentGetter: (_getterOptions?: EndowmentGetterParams) => undefined,\n    validator: ({ caveats }) => {\n      if (\n        (caveats !== null && caveats?.length > 1) ||\n        (caveats?.length === 1 &&\n          caveats[0].type !== SnapCaveatType.TransactionOrigin)\n      ) {\n        throw ethErrors.rpc.invalidParams({\n          message: `Expected a single \"${SnapCaveatType.TransactionOrigin}\" caveat.`,\n        });\n      }\n    },\n    subjectTypes: [SubjectType.Snap],\n  };\n};\n\nexport const transactionInsightEndowmentBuilder = Object.freeze({\n  targetName: permissionName,\n  specificationBuilder,\n} as const);\n\n/**\n * Validates the type of the caveat value.\n *\n * @param caveat - The caveat to validate.\n * @throws If the caveat value is invalid.\n */\nfunction validateCaveat(caveat: Caveat<string, any>): void {\n  if (!hasProperty(caveat, 'value') || !isPlainObject(caveat)) {\n    throw ethErrors.rpc.invalidParams({\n      message: 'Expected a plain object.',\n    });\n  }\n\n  const { value } = caveat;\n\n  assert(\n    typeof value === 'boolean',\n    'Expected caveat value to have type \"boolean\"',\n  );\n}\n\n/**\n * Map a raw value from the `initialPermissions` to a caveat specification.\n * Note that this function does not do any validation, that's handled by the\n * PermissionsController when the permission is requested.\n *\n * @param value - The raw value from the `initialPermissions`.\n * @returns The caveat specification.\n */\nexport function getTransactionInsightCaveatMapper(\n  value: Json,\n): Pick<PermissionConstraint, 'caveats'> {\n  if (\n    !value ||\n    !isObject(value) ||\n    (isObject(value) && Object.keys(value).length === 0)\n  ) {\n    return { caveats: null };\n  }\n  return {\n    caveats: [\n      {\n        type: SnapCaveatType.TransactionOrigin,\n        value:\n          hasProperty(value, 'allowTransactionOrigin') &&\n          (value.allowTransactionOrigin as boolean),\n      },\n    ],\n  };\n}\n\n/**\n * Getter function to get the transaction origin caveat from a permission.\n *\n * This does basic validation of the caveat, but does not validate the type or\n * value of the namespaces object itself, as this is handled by the\n * `PermissionsController` when the permission is requested.\n *\n * @param permission - The permission to get the transaction origin caveat from.\n * @returns The transaction origin, or `null` if the permission does not have a\n * transaction origin caveat.\n */\nexport function getTransactionOriginCaveat(\n  permission?: PermissionConstraint,\n): boolean | null {\n  if (!permission?.caveats) {\n    return null;\n  }\n\n  assert(permission.caveats.length === 1);\n  assert(permission.caveats[0].type === SnapCaveatType.TransactionOrigin);\n\n  const caveat = permission.caveats[0] as Caveat<string, boolean>;\n\n  return caveat.value ?? null;\n}\n\nexport const transactionInsightCaveatSpecifications: Record<\n  SnapCaveatType.TransactionOrigin,\n  CaveatSpecificationConstraint\n> = {\n  [SnapCaveatType.TransactionOrigin]: Object.freeze({\n    type: SnapCaveatType.TransactionOrigin,\n    validator: (caveat: Caveat<string, any>) => validateCaveat(caveat),\n  }),\n};\n"],"names":["transactionInsightEndowmentBuilder","getTransactionInsightCaveatMapper","getTransactionOriginCaveat","transactionInsightCaveatSpecifications","permissionName","SnapEndowments","TransactionInsight","specificationBuilder","_builderOptions","permissionType","PermissionType","Endowment","targetName","allowedCaveats","SnapCaveatType","TransactionOrigin","endowmentGetter","_getterOptions","undefined","validator","caveats","length","type","ethErrors","rpc","invalidParams","message","subjectTypes","SubjectType","Snap","Object","freeze","validateCaveat","caveat","hasProperty","isPlainObject","value","assert","isObject","keys","allowTransactionOrigin","permission"],"mappings":";;;;;;;;;;;IA2DaA,kCAAkC;eAAlCA;;IAkCGC,iCAAiC;eAAjCA;;IAiCAC,0BAA0B;eAA1BA;;IAeHC,sCAAsC;eAAtCA;;;sCApI+B;4BACb;uBAE8B;8BACnC;sBAEK;AAE/B,MAAMC,iBAAiBC,oBAAc,CAACC,kBAAkB;AAUxD;;;;;;CAMC,GACD,MAAMC,uBAIF,CAACC;IACH,OAAO;QACLC,gBAAgBC,oCAAc,CAACC,SAAS;QACxCC,YAAYR;QACZS,gBAAgB;YAACC,0BAAc,CAACC,iBAAiB;SAAC;QAClDC,iBAAiB,CAACC,iBAA2CC;QAC7DC,WAAW,CAAC,EAAEC,OAAO,EAAE;YACrB,IACE,AAACA,YAAY,QAAQA,SAASC,SAAS,KACtCD,SAASC,WAAW,KACnBD,OAAO,CAAC,EAAE,CAACE,IAAI,KAAKR,0BAAc,CAACC,iBAAiB,EACtD;gBACA,MAAMQ,uBAAS,CAACC,GAAG,CAACC,aAAa,CAAC;oBAChCC,SAAS,CAAC,mBAAmB,EAAEZ,0BAAc,CAACC,iBAAiB,CAAC,SAAS,CAAC;gBAC5E;YACF;QACF;QACAY,cAAc;YAACC,iCAAW,CAACC,IAAI;SAAC;IAClC;AACF;AAEO,MAAM7B,qCAAqC8B,OAAOC,MAAM,CAAC;IAC9DnB,YAAYR;IACZG;AACF;AAEA;;;;;CAKC,GACD,SAASyB,eAAeC,MAA2B;IACjD,IAAI,CAACC,IAAAA,kBAAW,EAACD,QAAQ,YAAY,CAACE,IAAAA,oBAAa,EAACF,SAAS;QAC3D,MAAMV,uBAAS,CAACC,GAAG,CAACC,aAAa,CAAC;YAChCC,SAAS;QACX;IACF;IAEA,MAAM,EAAEU,KAAK,EAAE,GAAGH;IAElBI,IAAAA,aAAM,EACJ,OAAOD,UAAU,WACjB;AAEJ;AAUO,SAASnC,kCACdmC,KAAW;IAEX,IACE,CAACA,SACD,CAACE,IAAAA,eAAQ,EAACF,UACTE,IAAAA,eAAQ,EAACF,UAAUN,OAAOS,IAAI,CAACH,OAAOf,MAAM,KAAK,GAClD;QACA,OAAO;YAAED,SAAS;QAAK;IACzB;IACA,OAAO;QACLA,SAAS;YACP;gBACEE,MAAMR,0BAAc,CAACC,iBAAiB;gBACtCqB,OACEF,IAAAA,kBAAW,EAACE,OAAO,6BAClBA,MAAMI,sBAAsB;YACjC;SACD;IACH;AACF;AAaO,SAAStC,2BACduC,UAAiC;IAEjC,IAAI,CAACA,YAAYrB,SAAS;QACxB,OAAO;IACT;IAEAiB,IAAAA,aAAM,EAACI,WAAWrB,OAAO,CAACC,MAAM,KAAK;IACrCgB,IAAAA,aAAM,EAACI,WAAWrB,OAAO,CAAC,EAAE,CAACE,IAAI,KAAKR,0BAAc,CAACC,iBAAiB;IAEtE,MAAMkB,SAASQ,WAAWrB,OAAO,CAAC,EAAE;IAEpC,OAAOa,OAAOG,KAAK,IAAI;AACzB;AAEO,MAAMjC,yCAGT;IACF,CAACW,0BAAc,CAACC,iBAAiB,CAAC,EAAEe,OAAOC,MAAM,CAAC;QAChDT,MAAMR,0BAAc,CAACC,iBAAiB;QACtCI,WAAW,CAACc,SAAgCD,eAAeC;IAC7D;AACF"}