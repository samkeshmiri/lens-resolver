{"version":3,"sources":["../../../../src/snaps/endowments/rpc.ts"],"sourcesContent":["import type {\n  Caveat,\n  CaveatSpecificationConstraint,\n  EndowmentGetterParams,\n  PermissionConstraint,\n  PermissionSpecificationBuilder,\n  PermissionValidatorConstraint,\n  ValidPermissionSpecification,\n} from '@metamask/permission-controller';\nimport { PermissionType, SubjectType } from '@metamask/permission-controller';\nimport type { RpcOrigins } from '@metamask/snaps-utils';\nimport { assertIsRpcOrigins, SnapCaveatType } from '@metamask/snaps-utils';\nimport type { Json, NonEmptyArray } from '@metamask/utils';\nimport { hasProperty, isPlainObject, assert } from '@metamask/utils';\nimport { ethErrors } from 'eth-rpc-errors';\n\nimport { SnapEndowments } from './enum';\n\nconst targetName = SnapEndowments.Rpc;\n\ntype RpcSpecification = ValidPermissionSpecification<{\n  permissionType: PermissionType.Endowment;\n  targetName: typeof targetName;\n  endowmentGetter: (_options?: any) => undefined;\n  allowedCaveats: Readonly<NonEmptyArray<string>> | null;\n  validator: PermissionValidatorConstraint;\n  subjectTypes: readonly SubjectType[];\n}>;\n\ntype RpcSpecificationBuilderOptions = {\n  // Empty for now.\n};\n\n/**\n * The specification builder for the JSON-RPC endowment permission.\n *\n * @param _builderOptions - Optional specification builder options.\n * @returns The specification for the JSON-RPC endowment permission.\n */\nconst specificationBuilder: PermissionSpecificationBuilder<\n  PermissionType.Endowment,\n  RpcSpecificationBuilderOptions,\n  RpcSpecification\n> = (_builderOptions?: any): RpcSpecification => {\n  return {\n    permissionType: PermissionType.Endowment,\n    targetName,\n    allowedCaveats: [SnapCaveatType.RpcOrigin],\n    endowmentGetter: (_getterOptions?: EndowmentGetterParams) => undefined,\n    validator: ({ caveats }) => {\n      if (\n        caveats?.length !== 1 ||\n        caveats[0].type !== SnapCaveatType.RpcOrigin\n      ) {\n        throw ethErrors.rpc.invalidParams({\n          message: `Expected a single \"${SnapCaveatType.RpcOrigin}\" caveat.`,\n        });\n      }\n    },\n    subjectTypes: [SubjectType.Snap],\n  };\n};\n\nexport const rpcEndowmentBuilder = Object.freeze({\n  targetName,\n  specificationBuilder,\n} as const);\n\n/**\n * Validate the value of a caveat. This does not validate the type of the\n * caveat itself, only the value of the caveat.\n *\n * @param caveat - The caveat to validate.\n * @throws If the caveat value is invalid.\n */\nfunction validateCaveatOrigins(caveat: Caveat<string, any>) {\n  if (!hasProperty(caveat, 'value') || !isPlainObject(caveat.value)) {\n    throw ethErrors.rpc.invalidParams({\n      message: 'Invalid JSON-RPC origins: Expected a plain object.',\n    });\n  }\n\n  const { value } = caveat;\n  assertIsRpcOrigins(value, ethErrors.rpc.invalidParams);\n}\n\n/**\n * Map a raw value from the `initialPermissions` to a caveat specification.\n * Note that this function does not do any validation, that's handled by the\n * PermissionsController when the permission is requested.\n *\n * @param value - The raw value from the `initialPermissions`.\n * @returns The caveat specification.\n */\nexport function getRpcCaveatMapper(\n  value: Json,\n): Pick<PermissionConstraint, 'caveats'> {\n  return {\n    caveats: [\n      {\n        type: SnapCaveatType.RpcOrigin,\n        value,\n      },\n    ],\n  };\n}\n\n/**\n * Getter function to get the {@link RpcOrigins} caveat value from a permission.\n *\n * @param permission - The permission to get the caveat value from.\n * @returns The caveat value.\n * @throws If the permission does not have a valid {@link RpcOrigins} caveat.\n */\nexport function getRpcCaveatOrigins(\n  permission?: PermissionConstraint,\n): RpcOrigins | null {\n  assert(permission?.caveats);\n  assert(permission.caveats.length === 1);\n  assert(permission.caveats[0].type === SnapCaveatType.RpcOrigin);\n\n  const caveat = permission.caveats[0] as Caveat<string, RpcOrigins>;\n  return caveat.value;\n}\n\nexport const rpcCaveatSpecifications: Record<\n  SnapCaveatType.RpcOrigin,\n  CaveatSpecificationConstraint\n> = {\n  [SnapCaveatType.RpcOrigin]: Object.freeze({\n    type: SnapCaveatType.RpcOrigin,\n    validator: (caveat: Caveat<string, any>) => validateCaveatOrigins(caveat),\n  }),\n};\n"],"names":["rpcEndowmentBuilder","getRpcCaveatMapper","getRpcCaveatOrigins","rpcCaveatSpecifications","targetName","SnapEndowments","Rpc","specificationBuilder","_builderOptions","permissionType","PermissionType","Endowment","allowedCaveats","SnapCaveatType","RpcOrigin","endowmentGetter","_getterOptions","undefined","validator","caveats","length","type","ethErrors","rpc","invalidParams","message","subjectTypes","SubjectType","Snap","Object","freeze","validateCaveatOrigins","caveat","hasProperty","isPlainObject","value","assertIsRpcOrigins","permission","assert"],"mappings":";;;;;;;;;;;IA+DaA,mBAAmB;eAAnBA;;IA+BGC,kBAAkB;eAAlBA;;IAoBAC,mBAAmB;eAAnBA;;IAWHC,uBAAuB;eAAvBA;;;sCApH+B;4BAEO;uBAEA;8BACzB;sBAEK;AAE/B,MAAMC,aAAaC,oBAAc,CAACC,GAAG;AAerC;;;;;CAKC,GACD,MAAMC,uBAIF,CAACC;IACH,OAAO;QACLC,gBAAgBC,oCAAc,CAACC,SAAS;QACxCP;QACAQ,gBAAgB;YAACC,0BAAc,CAACC,SAAS;SAAC;QAC1CC,iBAAiB,CAACC,iBAA2CC;QAC7DC,WAAW,CAAC,EAAEC,OAAO,EAAE;YACrB,IACEA,SAASC,WAAW,KACpBD,OAAO,CAAC,EAAE,CAACE,IAAI,KAAKR,0BAAc,CAACC,SAAS,EAC5C;gBACA,MAAMQ,uBAAS,CAACC,GAAG,CAACC,aAAa,CAAC;oBAChCC,SAAS,CAAC,mBAAmB,EAAEZ,0BAAc,CAACC,SAAS,CAAC,SAAS,CAAC;gBACpE;YACF;QACF;QACAY,cAAc;YAACC,iCAAW,CAACC,IAAI;SAAC;IAClC;AACF;AAEO,MAAM5B,sBAAsB6B,OAAOC,MAAM,CAAC;IAC/C1B;IACAG;AACF;AAEA;;;;;;CAMC,GACD,SAASwB,sBAAsBC,MAA2B;IACxD,IAAI,CAACC,IAAAA,kBAAW,EAACD,QAAQ,YAAY,CAACE,IAAAA,oBAAa,EAACF,OAAOG,KAAK,GAAG;QACjE,MAAMb,uBAAS,CAACC,GAAG,CAACC,aAAa,CAAC;YAChCC,SAAS;QACX;IACF;IAEA,MAAM,EAAEU,KAAK,EAAE,GAAGH;IAClBI,IAAAA,8BAAkB,EAACD,OAAOb,uBAAS,CAACC,GAAG,CAACC,aAAa;AACvD;AAUO,SAASvB,mBACdkC,KAAW;IAEX,OAAO;QACLhB,SAAS;YACP;gBACEE,MAAMR,0BAAc,CAACC,SAAS;gBAC9BqB;YACF;SACD;IACH;AACF;AASO,SAASjC,oBACdmC,UAAiC;IAEjCC,IAAAA,aAAM,EAACD,YAAYlB;IACnBmB,IAAAA,aAAM,EAACD,WAAWlB,OAAO,CAACC,MAAM,KAAK;IACrCkB,IAAAA,aAAM,EAACD,WAAWlB,OAAO,CAAC,EAAE,CAACE,IAAI,KAAKR,0BAAc,CAACC,SAAS;IAE9D,MAAMkB,SAASK,WAAWlB,OAAO,CAAC,EAAE;IACpC,OAAOa,OAAOG,KAAK;AACrB;AAEO,MAAMhC,0BAGT;IACF,CAACU,0BAAc,CAACC,SAAS,CAAC,EAAEe,OAAOC,MAAM,CAAC;QACxCT,MAAMR,0BAAc,CAACC,SAAS;QAC9BI,WAAW,CAACc,SAAgCD,sBAAsBC;IACpE;AACF"}