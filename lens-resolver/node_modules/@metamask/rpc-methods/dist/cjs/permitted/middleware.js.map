{"version":3,"sources":["../../../src/permitted/middleware.ts"],"sourcesContent":["import { logError } from '@metamask/snaps-utils';\nimport { ethErrors } from 'eth-rpc-errors';\nimport type { JsonRpcMiddleware } from 'json-rpc-engine';\n\nimport { selectHooks } from '../utils';\nimport { methodHandlers } from './handlers';\n\n/**\n * Creates a middleware that handles permitted snap RPC methods.\n *\n * @param isSnap - A flag that should indicate whether the requesting origin is a snap or not.\n * @param hooks - An object containing the hooks made available to the permitted RPC methods.\n * @returns The middleware.\n */\nexport function createSnapsMethodMiddleware(\n  isSnap: boolean,\n  hooks: Record<string, unknown>,\n): JsonRpcMiddleware<unknown, unknown> {\n  // This is not actually a misused promise, the type is just wrong\n  // eslint-disable-next-line @typescript-eslint/no-misused-promises\n  return async function methodMiddleware(request, response, next, end) {\n    const handler =\n      methodHandlers[request.method as keyof typeof methodHandlers];\n    if (handler) {\n      if (request.method.startsWith('snap_') && !isSnap) {\n        return end(ethErrors.rpc.methodNotFound());\n      }\n\n      // TODO: Once json-rpc-engine types are up to date, we should type this correctly\n      const { implementation, hookNames } = handler as any;\n      try {\n        // Implementations may or may not be async, so we must await them.\n        return await implementation(\n          request,\n          response,\n          next,\n          end,\n          selectHooks(hooks, hookNames),\n        );\n      } catch (error) {\n        logError(error);\n        return end(error);\n      }\n    }\n\n    return next();\n  };\n}\n"],"names":["createSnapsMethodMiddleware","isSnap","hooks","methodMiddleware","request","response","next","end","handler","methodHandlers","method","startsWith","ethErrors","rpc","methodNotFound","implementation","hookNames","selectHooks","error","logError"],"mappings":";;;;+BAcgBA;;;eAAAA;;;4BAdS;8BACC;uBAGE;0BACG;AASxB,SAASA,4BACdC,MAAe,EACfC,KAA8B;IAE9B,iEAAiE;IACjE,kEAAkE;IAClE,OAAO,eAAeC,iBAAiBC,OAAO,EAAEC,QAAQ,EAAEC,IAAI,EAAEC,GAAG;QACjE,MAAMC,UACJC,wBAAc,CAACL,QAAQM,MAAM,CAAgC;QAC/D,IAAIF,SAAS;YACX,IAAIJ,QAAQM,MAAM,CAACC,UAAU,CAAC,YAAY,CAACV,QAAQ;gBACjD,OAAOM,IAAIK,uBAAS,CAACC,GAAG,CAACC,cAAc;YACzC;YAEA,iFAAiF;YACjF,MAAM,EAAEC,cAAc,EAAEC,SAAS,EAAE,GAAGR;YACtC,IAAI;gBACF,kEAAkE;gBAClE,OAAO,MAAMO,eACXX,SACAC,UACAC,MACAC,KACAU,IAAAA,kBAAW,EAACf,OAAOc;YAEvB,EAAE,OAAOE,OAAO;gBACdC,IAAAA,oBAAQ,EAACD;gBACT,OAAOX,IAAIW;YACb;QACF;QAEA,OAAOZ;IACT;AACF"}