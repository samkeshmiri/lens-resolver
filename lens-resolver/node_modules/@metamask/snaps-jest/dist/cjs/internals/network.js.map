{"version":3,"sources":["../../../src/internals/network.ts"],"sourcesContent":["import { JSON_RPC_ENDPOINT } from '@metamask/snaps-simulator';\nimport { createModuleLogger, UnsafeJsonStruct } from '@metamask/utils';\nimport type { Page, HTTPRequest } from 'puppeteer';\nimport type { Infer, Struct } from 'superstruct';\nimport {\n  assign,\n  boolean,\n  create,\n  defaulted,\n  number,\n  object,\n  optional,\n  record,\n  regexp,\n  string,\n  union,\n  unknown,\n  func,\n} from 'superstruct';\n\nimport type { DeepPartial } from '../types';\nimport { rootLogger } from './logger';\n\n/**\n * The default headers to use for mocked responses. These headers are used to\n * enable CORS.\n */\nconst DEFAULT_HEADERS = {\n  /* eslint-disable @typescript-eslint/naming-convention */\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Credentials': 'true',\n  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n  'Access-Control-Allow-Headers':\n    'Access-Control-Allow-Headers, Origin,Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers',\n  /* eslint-enable @typescript-eslint/naming-convention */\n};\n\nconst log = createModuleLogger(rootLogger, 'network');\n\nexport type Unmock = () => Promise<void>;\n\nexport type Mock = {\n  /**\n   * A function that can be used to unmock the URL.\n   */\n  unmock: Unmock;\n};\n\n/**\n * A function that can return `true` if the given request should be mocked, or\n * false if not.\n *\n * @param request - The request to check.\n * @returns Whether to mock the request.\n */\nexport type ConditionFunction = (request: HTTPRequest) => boolean;\n\nconst MockOptionsBaseStruct = object({\n  response: defaulted(\n    object({\n      status: defaulted(number(), 200),\n      headers: defaulted(record(string(), unknown()), DEFAULT_HEADERS),\n      contentType: defaulted(string(), 'text/plain'),\n\n      // Note: We default to a newline here, because the fetch request never\n      // resolves if the body is empty.\n      body: defaulted(string(), '\\n'),\n    }),\n    {},\n  ),\n});\n\nconst MockOptionsUrlStruct = object({\n  url: union([string(), regexp()]),\n  partial: optional(boolean()),\n});\n\nconst MockOptionsConditionStruct = object({\n  condition: func() as unknown as Struct<ConditionFunction, null>,\n});\n\nexport const MockOptionsStruct = union([\n  assign(MockOptionsBaseStruct, MockOptionsUrlStruct),\n  assign(MockOptionsBaseStruct, MockOptionsConditionStruct),\n]);\n\n/**\n * The options for the network mocking.\n *\n * @property url - The URL to mock. If a string is provided, the URL will be\n * matched exactly. If a RegExp is provided, the URL will be matched against it.\n * This option is incompatible with the `condition` option.\n * @property partial - If enabled, the request will be mocked if the URL starts\n * with the given URL. This option is ignored if a RegExp is provided to the\n * `url` option. This option is incompatible with the `condition` option.\n * @property condition - A function which gets the {@link HTTPRequest} as\n * parameter and returns a boolean to indicate whether the response should be\n * mocked or not. This option is incompatible with the `url` and `partial`\n * options.\n * @property response - The response to send for the request.\n * @property response.status - The status code to send for the response.\n * Defaults to `200`.\n * @property response.headers - The headers to send for the response. Defaults\n * to headers that enable CORS.\n * @property response.contentType - The content type to send for the response.\n * Defaults to `text/plain`.\n */\nexport type MockOptions = Infer<typeof MockOptionsStruct>;\n\n/**\n * Check if the given URL matches the given request, or if the condition\n * function returns `true`.\n *\n * @param request - The request to check.\n * @param options - The options for the network mocking.\n * @returns Whether the URL matches the request.\n */\nfunction matches(request: HTTPRequest, options: MockOptions) {\n  if ('url' in options) {\n    const { url, partial } = options;\n    if (typeof url === 'string') {\n      if (partial) {\n        return request.url().startsWith(url);\n      }\n\n      return url === request.url();\n    }\n\n    return url.test(request.url());\n  }\n\n  const { condition } = options;\n  return condition(request);\n}\n\n/**\n * Enable network mocking for the given page, and all its sub-frames.\n *\n * @param page - The page to enable network mocking on.\n * @param options - The options for the network mocking.\n * @returns A {@link Mock} object, with an `unmock` function.\n */\nexport async function mock(\n  page: Page,\n  options: DeepPartial<MockOptions>,\n): Promise<Mock> {\n  await page.setRequestInterception(true);\n\n  const parsedOptions = create(options, MockOptionsStruct);\n\n  /**\n   * The mock handler.\n   *\n   * @param request - The request to handle.\n   */\n  function handler(request: HTTPRequest) {\n    // If the request is already handled, Puppeteer will throw an error if we\n    // try to continue the request.\n    if (request.isInterceptResolutionHandled()) {\n      return;\n    }\n\n    if (!matches(request, parsedOptions)) {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      request.continue();\n      return;\n    }\n\n    log('Mocking request to %s', request.url());\n\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    request.respond(parsedOptions.response);\n  }\n\n  /**\n   * Unmock the page.\n   */\n  async function unmock() {\n    await page.setRequestInterception(false);\n    page.off('request', handler);\n  }\n\n  page.on('request', handler);\n\n  return {\n    unmock,\n  };\n}\n\nconst MockJsonRpcOptionsStruct = object({\n  method: string(),\n  result: UnsafeJsonStruct,\n});\n\nexport type MockJsonRpcOptions = Infer<typeof MockJsonRpcOptionsStruct>;\n\n/**\n * Mock an Ethereum JSON-RPC request. This intercepts all requests to the\n * Ethereum provider, and returns the `result` instead.\n *\n * @param page - The page to enable network JSON-RPC mocking on.\n * @param options - The options for the JSON-RPC mock.\n * @param options.method - The JSON-RPC method to mock. Any other methods will be\n * forwarded to the provider.\n * @param options.result - The JSON response to return.\n * @returns A {@link Mock} object, with an `unmock` function.\n */\nexport async function mockJsonRpc(\n  page: Page,\n  { method, result }: MockJsonRpcOptions,\n) {\n  return await mock(page, {\n    condition: (request: HTTPRequest) => {\n      if (request.url() !== JSON_RPC_ENDPOINT) {\n        return false;\n      }\n\n      const body = request.postData();\n      if (!body) {\n        return false;\n      }\n\n      try {\n        const json = JSON.parse(body);\n        return json.method === method;\n      } catch (error) {\n        log(\n          `Unable to mock \"${method}\" request to Ethereum provider: %s`,\n          error.message,\n        );\n        return false;\n      }\n    },\n    response: {\n      status: 200,\n      contentType: 'application/json',\n      body: JSON.stringify({\n        jsonrpc: '2.0',\n        id: 1,\n        result,\n      }),\n    },\n  });\n}\n"],"names":["MockOptionsStruct","mock","mockJsonRpc","DEFAULT_HEADERS","log","createModuleLogger","rootLogger","MockOptionsBaseStruct","object","response","defaulted","status","number","headers","record","string","unknown","contentType","body","MockOptionsUrlStruct","url","union","regexp","partial","optional","boolean","MockOptionsConditionStruct","condition","func","assign","matches","request","options","startsWith","test","page","setRequestInterception","parsedOptions","create","handler","isInterceptResolutionHandled","continue","respond","unmock","off","on","MockJsonRpcOptionsStruct","method","result","UnsafeJsonStruct","JSON_RPC_ENDPOINT","postData","json","JSON","parse","error","message","stringify","jsonrpc","id"],"mappings":"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"}